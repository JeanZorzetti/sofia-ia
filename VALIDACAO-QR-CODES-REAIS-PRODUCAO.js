/**
 * üî• TESTE: Validar QR Codes REAIS em Produ√ß√£o
 * Verifica se os QR codes est√£o sendo gerados corretamente
 * Conex√£o: sofia-dash.roilabs.com.br ‚Üí sofia-api.roilabs.com.br
 */

// üéØ URLs de produ√ß√£o
const DASHBOARD_URL = 'https://sofia-dash.roilabs.com.br';
const API_URL = 'https://sofia-api.roilabs.com.br';
const EVOLUTION_URL = 'https://evolutionapi.roilabs.com.br';

console.log('üî• INICIANDO VALIDA√á√ÉO QR CODES REAIS');
console.log('=====================================');

// ‚úÖ Teste 1: Verificar se dashboard carrega
async function testeDashboardCarrega() {
  console.log('\nüìä TESTE 1: Dashboard carrega?');
  
  try {
    const response = await fetch(DASHBOARD_URL);
    
    if (response.ok) {
      console.log('‚úÖ Dashboard acess√≠vel:', response.status);
      return true;
    } else {
      console.log('‚ùå Dashboard inacess√≠vel:', response.status);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Erro ao acessar dashboard:', error.message);
    return false;
  }
}

// ‚úÖ Teste 2: Verificar se API est√° funcionando
async function testeAPIFuncionando() {
  console.log('\nüîß TESTE 2: API produ√ß√£o funcionando?');
  
  try {
    const response = await fetch(`${API_URL}/health`);
    
    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ API saud√°vel:', {
        status: data.success,
        uptime: data.uptime,
        timestamp: data.timestamp
      });
      return true;
    } else {
      console.log('‚ùå API com problemas:', response.status);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Erro na API:', error.message);
    return false;
  }
}

// ‚úÖ Teste 3: Verificar endpoint de WhatsApp instances
async function testeWhatsAppEndpoint() {
  console.log('\nüì± TESTE 3: WhatsApp endpoints funcionando?');
  
  try {
    const response = await fetch(`${API_URL}/api/whatsapp/instances`);
    
    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ WhatsApp endpoint OK:', {
        success: data.success,
        instances: data.data?.length || 0,
        stats: data.stats
      });
      return true;
    } else {
      console.log('‚ùå WhatsApp endpoint erro:', response.status);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Erro WhatsApp endpoint:', error.message);
    return false;
  }
}

// ‚úÖ Teste 4: Testar cria√ß√£o de inst√¢ncia (simula√ß√£o)
async function testeCriarInstancia() {
  console.log('\nüÜï TESTE 4: Criar inst√¢ncia de teste');
  
  try {
    const response = await fetch(`${API_URL}/api/whatsapp/instances`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: 'TesteSofiaValidacao',
        force_production: true,
        evolution_api_url: EVOLUTION_URL
      }),
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ Inst√¢ncia criada:', {
        success: data.success,
        instanceId: data.data?.id,
        name: data.data?.name
      });
      
      return data.data?.id;
    } else {
      console.log('‚ùå Erro ao criar inst√¢ncia:', response.status);
      return null;
    }
  } catch (error) {
    console.log('‚ùå Erro na cria√ß√£o:', error.message);
    return null;
  }
}

// ‚úÖ Teste 5: Obter QR Code da inst√¢ncia
async function testeObterQRCode(instanceId) {
  console.log('\nüî≤ TESTE 5: Obter QR Code real');
  
  if (!instanceId) {
    console.log('‚ùå Sem instanceId para testar QR');
    return false;
  }
  
  try {
    const response = await fetch(`${API_URL}/api/whatsapp/instances/${instanceId}/qr`);
    
    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ QR Code obtido:', {
        success: data.success,
        hasQR: !!data.data?.qr_code,
        source: data.data?.source,
        apiUrl: data.data?.api_url,
        expiresIn: data.data?.expires_in
      });
      
      // Verificar se √© QR real (n√£o simula√ß√£o)
      const isReal = data.data?.source === 'evolution_api';
      console.log(isReal ? '‚úÖ QR REAL (Evolution API)' : '‚ö†Ô∏è QR Simulado');
      
      return isReal;
    } else {
      console.log('‚ùå Erro ao obter QR:', response.status);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Erro QR Code:', error.message);
    return false;
  }
}

// ‚úÖ Teste 6: Limpar inst√¢ncia de teste
async function testeLimparInstancia(instanceId) {
  console.log('\nüßπ TESTE 6: Limpar inst√¢ncia de teste');
  
  if (!instanceId) {
    console.log('‚ö†Ô∏è Sem instanceId para limpar');
    return true;
  }
  
  try {
    const response = await fetch(`${API_URL}/api/whatsapp/instances/${instanceId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      console.log('‚úÖ Inst√¢ncia removida:', instanceId);
      return true;
    } else {
      console.log('‚ö†Ô∏è Erro ao remover inst√¢ncia:', response.status);
      return false;
    }
  } catch (error) {
    console.log('‚ö†Ô∏è Erro na remo√ß√£o:', error.message);
    return false;
  }
}

// üöÄ Executar todos os testes
async function executarValidacaoCompleta() {
  console.log('üî• EXECUTANDO BATERIA DE TESTES COMPLETA');
  console.log('=======================================');
  
  const resultados = {};
  
  // Executar testes sequencialmente
  resultados.dashboard = await testeDashboardCarrega();
  resultados.api = await testeAPIFuncionando();
  resultados.whatsapp = await testeWhatsAppEndpoint();
  
  const instanceId = await testeCriarInstancia();
  resultados.criarInstancia = !!instanceId;
  
  resultados.qrReal = await testeObterQRCode(instanceId);
  resultados.limpeza = await testeLimparInstancia(instanceId);
  
  // Resumo final
  console.log('\nüéØ RESUMO FINAL DOS TESTES');
  console.log('=========================');
  
  Object.entries(resultados).forEach(([teste, passou]) => {
    console.log(`${passou ? '‚úÖ' : '‚ùå'} ${teste.toUpperCase()}`);
  });
  
  const todosPassed = Object.values(resultados).every(r => r);
  
  console.log('\nüèÜ RESULTADO GERAL:');
  if (todosPassed) {
    console.log('‚úÖ TODOS OS TESTES PASSARAM!');
    console.log('üéâ QR Codes REAIS funcionando em produ√ß√£o');
    console.log('üöÄ Sofia IA pronta para uso end-to-end');
  } else {
    console.log('‚ùå ALGUNS TESTES FALHARAM');
    console.log('üîß Verificar configura√ß√£o e tentar novamente');
  }
  
  return todosPassed;
}

// ‚ö° Executar se chamado diretamente
if (typeof window === 'undefined') {
  // Node.js environment
  executarValidacaoCompleta().then(sucesso => {
    process.exit(sucesso ? 0 : 1);
  });
} else {
  // Browser environment
  console.log('üåê Execute executarValidacaoCompleta() no console');
}

// Export para uso
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    executarValidacaoCompleta,
    testeDashboardCarrega,
    testeAPIFuncionando,
    testeWhatsAppEndpoint,
    testeCriarInstancia,
    testeObterQRCode,
    testeLimparInstancia
  };
}
