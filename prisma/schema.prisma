generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(255)
  role         String    @default("agent") @db.VarChar(50)
  status       String    @default("active") @db.VarChar(20)
  permissions  Json      @default("{}")
  lastLogin    DateTime? @map("last_login") @db.Timestamptz()
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  leads     Lead[]
  campaigns Campaign[]
  agents    Agent[]
  workflows Workflow[]

  @@map("users")
}

model Lead {
  id              String    @id @default(uuid()) @db.Uuid
  nome            String    @db.VarChar(255)
  telefone        String    @unique @db.VarChar(20)
  email           String?   @db.VarChar(255)
  status          String    @default("novo") @db.VarChar(20)
  score           Int       @default(0)
  interesse       String?   @db.Text
  valorMin        Int?      @map("valor_min")
  valorMax        Int?      @map("valor_max")
  regiao          String?   @db.VarChar(255)
  tipoImovel      String?   @map("tipo_imovel") @db.VarChar(50)
  fonte           String    @default("whatsapp") @db.VarChar(50)
  metadata        Json      @default("{}")
  ultimaInteracao DateTime  @default(now()) @map("ultima_interacao") @db.Timestamptz()
  assignedTo      String?   @map("assigned_to") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  assignedUser  User?          @relation(fields: [assignedTo], references: [id])
  conversations Conversation[]
  messages      Message[]

  @@index([telefone])
  @@index([status])
  @@index([score(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([ultimaInteracao(sort: Desc)])
  @@map("leads")
}

model Conversation {
  id              String   @id @default(uuid()) @db.Uuid
  leadId          String   @map("lead_id") @db.Uuid
  agentId         String?  @map("agent_id") @db.Uuid
  whatsappChatId  String?  @map("whatsapp_chat_id") @db.VarChar(255)
  channel         String   @default("whatsapp") @db.VarChar(50)
  status          String   @default("active") @db.VarChar(20)
  handledBy       String   @default("ai") @map("handled_by") @db.VarChar(20)
  tags            String[] @default([])
  notes           String?  @db.Text
  unreadCount     Int      @default(0) @map("unread_count")
  startedAt       DateTime @default(now()) @map("started_at") @db.Timestamptz()
  lastMessageAt   DateTime @default(now()) @map("last_message_at") @db.Timestamptz()
  messageCount    Int      @default(0) @map("message_count")
  closedAt        DateTime? @map("closed_at") @db.Timestamptz()
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  lead     Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([handledBy])
  @@index([channel])
  @@index([lastMessageAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id                String    @id @default(uuid()) @db.Uuid
  conversationId    String    @map("conversation_id") @db.Uuid
  leadId            String    @map("lead_id") @db.Uuid
  whatsappMessageId String?   @map("whatsapp_message_id") @db.VarChar(255)
  sender            String    @db.VarChar(20)
  messageType       String    @default("text") @map("message_type") @db.VarChar(20)
  content           String    @db.Text
  mediaUrl          String?   @map("media_url") @db.Text
  mediaCaption      String?   @map("media_caption") @db.Text
  isAiGenerated     Boolean   @default(false) @map("is_ai_generated")
  aiModel           String?   @map("ai_model") @db.VarChar(50)
  aiConfidence      Float?    @map("ai_confidence")
  sentAt            DateTime  @default(now()) @map("sent_at") @db.Timestamptz()
  deliveredAt       DateTime? @map("delivered_at") @db.Timestamptz()
  readAt            DateTime? @map("read_at") @db.Timestamptz()
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([leadId])
  @@index([sentAt(sort: Desc)])
  @@index([sender])
  @@map("messages")
}

model Campaign {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  type            String    @default("drip") @db.VarChar(50)
  status          String    @default("draft") @db.VarChar(20)
  targetCriteria  Json      @default("{}") @map("target_criteria")
  messageTemplate String?   @map("message_template") @db.Text
  scheduleConfig  Json      @default("{}") @map("schedule_config")
  leadsCount      Int       @default(0) @map("leads_count")
  messagesSent    Int       @default(0) @map("messages_sent")
  conversionCount Int       @default(0) @map("conversion_count")
  conversionRate  Float     @default(0) @map("conversion_rate")
  createdBy       String?   @map("created_by") @db.Uuid
  startedAt       DateTime? @map("started_at") @db.Timestamptz()
  endedAt         DateTime? @map("ended_at") @db.Timestamptz()
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator User? @relation(fields: [createdBy], references: [id])

  @@map("campaigns")
}

model AnalyticsDaily {
  id                     String   @id @default(uuid()) @db.Uuid
  date                   DateTime @unique @db.Date
  conversationsStarted   Int      @default(0) @map("conversations_started")
  conversationsCompleted Int      @default(0) @map("conversations_completed")
  messagesSent           Int      @default(0) @map("messages_sent")
  messagesReceived       Int      @default(0) @map("messages_received")
  leadsCreated           Int      @default(0) @map("leads_created")
  leadsQualified         Int      @default(0) @map("leads_qualified")
  conversionCount        Int      @default(0) @map("conversion_count")
  conversionRate         Float    @default(0) @map("conversion_rate")
  avgResponseTime        Float    @default(0) @map("avg_response_time")
  aiInteractions         Int      @default(0) @map("ai_interactions")
  metadata               Json     @default("{}")
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([date(sort: Desc)])
  @@map("analytics_daily")
}

model Setting {
  id          String   @id @default(uuid()) @db.Uuid
  category    String   @db.VarChar(100)
  key         String   @db.VarChar(100)
  value       Json
  description String?  @db.Text
  isEncrypted Boolean  @default(false) @map("is_encrypted")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([category, key])
  @@map("settings")
}

model WhatsappInstance {
  id                  String    @id @default(uuid()) @db.Uuid
  name                String    @unique @db.VarChar(100)
  phoneNumber         String?   @map("phone_number") @db.VarChar(20)
  status              String    @default("disconnected") @db.VarChar(20)
  qrCode              String?   @map("qr_code") @db.Text
  webhookUrl          String?   @map("webhook_url") @db.Text
  evolutionInstanceId String?   @map("evolution_instance_id") @db.VarChar(100)
  batteryLevel        Int?      @map("battery_level")
  lastSeen            DateTime? @map("last_seen") @db.Timestamptz()
  messagesSentToday   Int       @default(0) @map("messages_sent_today")
  messagesReceivedToday Int     @default(0) @map("messages_received_today")
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@map("whatsapp_instances")
}

model Agent {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  systemPrompt    String   @map("system_prompt") @db.Text
  model           String   @default("llama-3.3-70b-versatile") @db.VarChar(100)
  temperature     Float    @default(0.7)
  knowledgeBaseId String?  @map("knowledge_base_id") @db.Uuid
  status          String   @default("active") @db.VarChar(20)
  createdBy       String   @map("created_by") @db.Uuid
  config          Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator  User           @relation(fields: [createdBy], references: [id])
  channels AgentChannel[]

  @@index([status])
  @@index([createdBy])
  @@map("agents")
}

model AgentChannel {
  id        String   @id @default(uuid()) @db.Uuid
  agentId   String   @map("agent_id") @db.Uuid
  channel   String   @db.VarChar(50)
  config    Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, channel])
  @@index([agentId])
  @@index([channel])
  @@map("agent_channels")
}

model KnowledgeBase {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  agentId   String?  @map("agent_id") @db.Uuid
  type      String   @default("general") @db.VarChar(50)
  config    Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  documents KnowledgeDocument[]

  @@index([agentId])
  @@map("knowledge_bases")
}

model KnowledgeDocument {
  id              String   @id @default(uuid()) @db.Uuid
  knowledgeBaseId String   @map("knowledge_base_id") @db.Uuid
  title           String   @db.VarChar(500)
  content         String   @db.Text
  sourceUrl       String?  @map("source_url") @db.Text
  fileType        String?  @map("file_type") @db.VarChar(50)
  chunks          Json     @default("[]")
  status          String   @default("processing") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  @@index([knowledgeBaseId])
  @@index([status])
  @@map("knowledge_documents")
}

model Workflow {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  trigger      Json     @default("{}")
  conditions   Json     @default("[]")
  actions      Json     @default("[]")
  status       String   @default("inactive") @db.VarChar(20)
  lastRun      DateTime? @map("last_run") @db.Timestamptz()
  runCount     Int      @default(0) @map("run_count")
  successCount Int      @default(0) @map("success_count")
  createdBy    String   @map("created_by") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator    User                @relation(fields: [createdBy], references: [id])
  executions WorkflowExecution[]

  @@index([status])
  @@index([createdBy])
  @@map("workflows")
}

model WorkflowExecution {
  id          String    @id @default(uuid()) @db.Uuid
  workflowId  String    @map("workflow_id") @db.Uuid
  status      String    @default("pending") @db.VarChar(20)
  input       Json      @default("{}")
  output      Json?
  error       String?   @db.Text
  duration    Int?
  startedAt   DateTime  @default(now()) @map("started_at") @db.Timestamptz()
  completedAt DateTime? @map("completed_at") @db.Timestamptz()
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@map("workflow_executions")
}

model Integration {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  type        String   @db.VarChar(100)
  config      Json     @default("{}")
  credentials Json     @default("{}")
  status      String   @default("inactive") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([type])
  @@index([status])
  @@map("integrations")
}

model Template {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  description String   @db.Text
  category    String   @db.VarChar(100)
  type        String   @db.VarChar(50)
  icon        String?  @db.VarChar(50)
  config      Json     @default("{}")
  isOfficial  Boolean  @default(false) @map("is_official")
  usageCount  Int      @default(0) @map("usage_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([category])
  @@index([type])
  @@index([isOfficial])
  @@map("templates")
}

model ApiKey {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(255)
  key         String    @unique @db.VarChar(255)
  userId      String    @map("user_id") @db.Uuid
  lastUsedAt  DateTime? @map("last_used_at") @db.Timestamptz()
  status      String    @default("active") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([userId])
  @@index([status])
  @@map("api_keys")
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  action       String   @db.VarChar(100)
  userId       String?  @map("user_id") @db.Uuid
  resourceType String?  @map("resource_type") @db.VarChar(50)
  resourceId   String?  @map("resource_id") @db.Uuid
  details      Json     @default("{}")
  ipAddress    String?  @map("ip_address") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}
