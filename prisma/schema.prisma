generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(uuid()) @db.Uuid
  email                String    @unique @db.VarChar(255)
  passwordHash         String    @map("password_hash") @db.VarChar(255)
  name                 String    @db.VarChar(255)
  role                 String    @default("agent") @db.VarChar(50)
  status               String    @default("active") @db.VarChar(20)
  permissions          Json      @default("{}")
  workspaceId          String?   @map("workspace_id") @db.Uuid
  lastLogin            DateTime? @map("last_login") @db.Timestamptz()
  onboardingCompleted  Boolean   @default(false) @map("onboarding_completed")
  onboardingData       Json      @default("{}") @map("onboarding_data")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  workspace     Workspace?     @relation(fields: [workspaceId], references: [id])
  leads         Lead[]
  campaigns     Campaign[]
  agents        Agent[]
  flows         Flow[]
  subscription  Subscription?

  @@index([workspaceId])
  @@map("users")
}

model Lead {
  id              String    @id @default(uuid()) @db.Uuid
  nome            String    @db.VarChar(255)
  telefone        String    @unique @db.VarChar(20)
  email           String?   @db.VarChar(255)
  status          String    @default("novo") @db.VarChar(20)
  score           Int       @default(0)
  interesse       String?   @db.Text
  valorMin        Int?      @map("valor_min")
  valorMax        Int?      @map("valor_max")
  regiao          String?   @db.VarChar(255)
  tipoImovel      String?   @map("tipo_imovel") @db.VarChar(50)
  fonte           String    @default("whatsapp") @db.VarChar(50)
  metadata        Json      @default("{}")
  ultimaInteracao DateTime  @default(now()) @map("ultima_interacao") @db.Timestamptz()
  assignedTo      String?   @map("assigned_to") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  assignedUser  User?          @relation(fields: [assignedTo], references: [id])
  conversations Conversation[]
  messages      Message[]

  @@index([telefone])
  @@index([status])
  @@index([score(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([ultimaInteracao(sort: Desc)])
  @@map("leads")
}

model Conversation {
  id              String   @id @default(uuid()) @db.Uuid
  leadId          String   @map("lead_id") @db.Uuid
  agentId         String?  @map("agent_id") @db.Uuid
  whatsappChatId  String?  @map("whatsapp_chat_id") @db.VarChar(255)
  channel         String   @default("whatsapp") @db.VarChar(50)
  status          String   @default("active") @db.VarChar(20)
  handledBy       String   @default("ai") @map("handled_by") @db.VarChar(20)
  tags            String[] @default([])
  notes           String?  @db.Text
  unreadCount     Int      @default(0) @map("unread_count")
  startedAt       DateTime @default(now()) @map("started_at") @db.Timestamptz()
  lastMessageAt   DateTime @default(now()) @map("last_message_at") @db.Timestamptz()
  messageCount    Int      @default(0) @map("message_count")
  closedAt        DateTime? @map("closed_at") @db.Timestamptz()
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  lead     Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([handledBy])
  @@index([channel])
  @@index([lastMessageAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id                String    @id @default(uuid()) @db.Uuid
  conversationId    String    @map("conversation_id") @db.Uuid
  leadId            String    @map("lead_id") @db.Uuid
  whatsappMessageId String?   @map("whatsapp_message_id") @db.VarChar(255)
  sender            String    @db.VarChar(20)
  messageType       String    @default("text") @map("message_type") @db.VarChar(20)
  content           String    @db.Text
  mediaUrl          String?   @map("media_url") @db.Text
  mediaCaption      String?   @map("media_caption") @db.Text
  isAiGenerated     Boolean   @default(false) @map("is_ai_generated")
  aiModel           String?   @map("ai_model") @db.VarChar(50)
  aiConfidence      Float?    @map("ai_confidence")
  sentAt            DateTime  @default(now()) @map("sent_at") @db.Timestamptz()
  deliveredAt       DateTime? @map("delivered_at") @db.Timestamptz()
  readAt            DateTime? @map("read_at") @db.Timestamptz()
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([leadId])
  @@index([sentAt(sort: Desc)])
  @@index([sender])
  @@map("messages")
}

model Campaign {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  type            String    @default("drip") @db.VarChar(50)
  status          String    @default("draft") @db.VarChar(20)
  targetCriteria  Json      @default("{}") @map("target_criteria")
  messageTemplate String?   @map("message_template") @db.Text
  scheduleConfig  Json      @default("{}") @map("schedule_config")
  leadsCount      Int       @default(0) @map("leads_count")
  messagesSent    Int       @default(0) @map("messages_sent")
  conversionCount Int       @default(0) @map("conversion_count")
  conversionRate  Float     @default(0) @map("conversion_rate")
  createdBy       String?   @map("created_by") @db.Uuid
  startedAt       DateTime? @map("started_at") @db.Timestamptz()
  endedAt         DateTime? @map("ended_at") @db.Timestamptz()
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator User? @relation(fields: [createdBy], references: [id])

  @@map("campaigns")
}

model AnalyticsDaily {
  id                     String   @id @default(uuid()) @db.Uuid
  date                   DateTime @unique @db.Date
  conversationsStarted   Int      @default(0) @map("conversations_started")
  conversationsCompleted Int      @default(0) @map("conversations_completed")
  messagesSent           Int      @default(0) @map("messages_sent")
  messagesReceived       Int      @default(0) @map("messages_received")
  leadsCreated           Int      @default(0) @map("leads_created")
  leadsQualified         Int      @default(0) @map("leads_qualified")
  conversionCount        Int      @default(0) @map("conversion_count")
  conversionRate         Float    @default(0) @map("conversion_rate")
  avgResponseTime        Float    @default(0) @map("avg_response_time")
  aiInteractions         Int      @default(0) @map("ai_interactions")
  metadata               Json     @default("{}")
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([date(sort: Desc)])
  @@map("analytics_daily")
}

model Setting {
  id          String   @id @default(uuid()) @db.Uuid
  category    String   @db.VarChar(100)
  key         String   @db.VarChar(100)
  value       Json
  description String?  @db.Text
  isEncrypted Boolean  @default(false) @map("is_encrypted")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([category, key])
  @@map("settings")
}

model WhatsappInstance {
  id                  String    @id @default(uuid()) @db.Uuid
  name                String    @unique @db.VarChar(100)
  phoneNumber         String?   @map("phone_number") @db.VarChar(20)
  status              String    @default("disconnected") @db.VarChar(20)
  qrCode              String?   @map("qr_code") @db.Text
  webhookUrl          String?   @map("webhook_url") @db.Text
  evolutionInstanceId String?   @map("evolution_instance_id") @db.VarChar(100)
  batteryLevel        Int?      @map("battery_level")
  lastSeen            DateTime? @map("last_seen") @db.Timestamptz()
  messagesSentToday   Int       @default(0) @map("messages_sent_today")
  messagesReceivedToday Int     @default(0) @map("messages_received_today")
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@map("whatsapp_instances")
}

model Agent {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  systemPrompt    String   @map("system_prompt") @db.Text
  model           String   @default("llama-3.3-70b-versatile") @db.VarChar(100)
  temperature     Float    @default(0.7)
  knowledgeBaseId String?  @map("knowledge_base_id") @db.Uuid
  status          String   @default("active") @db.VarChar(20)
  createdBy       String   @map("created_by") @db.Uuid
  config          Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator  User           @relation(fields: [createdBy], references: [id])
  channels AgentChannel[]
  devSessions DevSession[]

  @@index([status])
  @@index([createdBy])
  @@map("agents")
}

model AgentChannel {
  id        String   @id @default(uuid()) @db.Uuid
  agentId   String   @map("agent_id") @db.Uuid
  channel   String   @db.VarChar(50)
  config    Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, channel])
  @@index([agentId])
  @@index([channel])
  @@map("agent_channels")
}

model KnowledgeBase {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  agentId   String?  @map("agent_id") @db.Uuid
  type      String   @default("general") @db.VarChar(50)
  config    Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  documents KnowledgeDocument[]

  @@index([agentId])
  @@map("knowledge_bases")
}

model KnowledgeDocument {
  id              String           @id @default(uuid()) @db.Uuid
  knowledgeBaseId String           @map("knowledge_base_id") @db.Uuid
  title           String           @db.VarChar(500)
  content         String           @db.Text
  sourceUrl       String?          @map("source_url") @db.Text
  fileType        String?          @map("file_type") @db.VarChar(50)
  chunks          Json             @default("[]")
  status          String           @default("processing") @db.VarChar(20)
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  knowledgeBase KnowledgeBase     @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  embeddings    DocumentEmbedding[]

  @@index([knowledgeBaseId])
  @@index([status])
  @@map("knowledge_documents")
}

/// Tabela de embeddings vetoriais usando pgvector
model DocumentEmbedding {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @map("document_id") @db.Uuid
  chunkIndex  Int      @map("chunk_index")
  chunkText   String   @map("chunk_text") @db.Text
  /// Vetor de 1536 dimensões (OpenAI text-embedding-3-small)
  /// ou 768 dimensões (Hugging Face all-MiniLM-L6-v2)
  // embedding   Unsupported("vector(1536)")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  document KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([documentId])
  @@index([chunkIndex])
  @@map("document_embeddings")
}

// ─────────────────────────────────────────────────────────
// Flow — N8N-style visual workflow automation
// ─────────────────────────────────────────────────────────
model Flow {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  description     String?   @db.Text

  // Visual graph (React Flow nodes + edges)
  nodes           Json      @default("[]")           // FlowNode[]
  edges           Json      @default("[]")           // FlowEdge[]

  // Global config
  settings        Json      @default("{}")           // { timezone, errorHandling, retryPolicy }
  variables       Json      @default("{}")           // user-defined key-value pairs

  // Status & metadata
  status          String    @default("draft") @db.VarChar(20) // draft | active | inactive | error
  version         Int       @default(1)
  tags            String[]  @default([])
  icon            String?   @db.VarChar(50)
  color           String?   @db.VarChar(20)

  // Trigger configuration
  triggerType     String    @default("manual") @map("trigger_type") @db.VarChar(30) // manual | webhook | cron | event
  cronExpression  String?   @map("cron_expression") @db.VarChar(100)
  webhookId       String?   @unique @map("webhook_id") @db.VarChar(100)

  // Execution stats (denormalized for perf)
  lastRunAt       DateTime? @map("last_run_at") @db.Timestamptz()
  runCount        Int       @default(0) @map("run_count")
  successCount    Int       @default(0) @map("success_count")

  // Relations
  createdBy       String    @map("created_by") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  creator         User            @relation(fields: [createdBy], references: [id])
  executions      FlowExecution[]
  versions        FlowVersion[]

  @@index([status])
  @@index([createdBy])
  @@index([triggerType])
  @@index([webhookId])
  @@map("flows")
}

model FlowExecution {
  id            String    @id @default(uuid()) @db.Uuid
  flowId        String    @map("flow_id") @db.Uuid

  status        String    @default("pending") @db.VarChar(20) // pending | running | success | failed | cancelled
  mode          String    @default("manual") @db.VarChar(20)  // manual | webhook | cron | trigger

  // Input/Output
  triggerData   Json?     @map("trigger_data")

  // Per-node tracking: { nodeId: { status, input, output, startedAt, duration, error } }
  nodeResults   Json      @default("{}") @map("node_results")

  // Timing
  startedAt     DateTime  @default(now()) @map("started_at") @db.Timestamptz()
  completedAt   DateTime? @map("completed_at") @db.Timestamptz()
  duration      Int?                                          // total ms

  // Error tracking
  error         String?   @db.Text
  errorNodeId   String?   @map("error_node_id") @db.VarChar(100)

  // Retry
  retryOf       String?   @map("retry_of") @db.Uuid
  retryCount    Int       @default(0) @map("retry_count")

  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  flow          Flow      @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@map("flow_executions")
}

// ─────────────────────────────────────────────────────────
// Flow Versioning — Snapshots for rollback
// ─────────────────────────────────────────────────────────
model FlowVersion {
  id         String   @id @default(uuid()) @db.Uuid
  flowId     String   @map("flow_id") @db.Uuid
  version    Int
  label      String?  @db.VarChar(255)
  nodes      Json     @default("[]")
  edges      Json     @default("[]")
  settings   Json     @default("{}")
  variables  Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  flow Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@unique([flowId, version])
  @@index([flowId])
  @@map("flow_versions")
}

model Integration {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  type        String   @db.VarChar(100)
  config      Json     @default("{}")
  credentials Json     @default("{}")
  status      String   @default("inactive") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([type])
  @@index([status])
  @@map("integrations")
}

model Template {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  description String   @db.Text
  category    String   @db.VarChar(100)
  subcategory String?  @db.VarChar(100)
  type        String   @db.VarChar(50)
  icon        String?  @db.VarChar(50)
  config      Json     @default("{}")
  isOfficial  Boolean  @default(false) @map("is_official")
  usageCount  Int      @default(0) @map("usage_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([category])
  @@index([subcategory])
  @@index([type])
  @@index([isOfficial])
  @@map("templates")
}

model ApiKey {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(255)
  key         String    @unique @db.VarChar(255)
  userId      String    @map("user_id") @db.Uuid
  lastUsedAt  DateTime? @map("last_used_at") @db.Timestamptz()
  status      String    @default("active") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([userId])
  @@index([status])
  @@map("api_keys")
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  action       String   @db.VarChar(100)
  userId       String?  @map("user_id") @db.Uuid
  resourceType String?  @map("resource_type") @db.VarChar(50)
  resourceId   String?  @map("resource_id") @db.Uuid
  details      Json     @default("{}")
  ipAddress    String?  @map("ip_address") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model AgentOrchestration {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  agents      Json     @default("[]")
  strategy    String   @default("sequential") @db.VarChar(50)
  config      Json     @default("{}")
  status      String   @default("active") @db.VarChar(20)
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  executions OrchestrationExecution[]

  @@index([status])
  @@index([createdBy])
  @@map("agent_orchestrations")
}

model OrchestrationExecution {
  id               String    @id @default(uuid()) @db.Uuid
  orchestrationId  String    @map("orchestration_id") @db.Uuid
  conversationId   String?   @map("conversation_id") @db.Uuid
  status           String    @default("pending") @db.VarChar(20)
  currentAgentId   String?   @map("current_agent_id") @db.Uuid
  agentResults     Json      @default("[]") @map("agent_results")
  input            Json      @default("{}")
  output           Json?
  error            String?   @db.Text
  durationMs       Int?      @map("duration_ms")
  tokensUsed       Int?      @map("tokens_used")
  estimatedCost    Float?    @map("estimated_cost")
  startedAt        DateTime  @default(now()) @map("started_at") @db.Timestamptz()
  completedAt      DateTime? @map("completed_at") @db.Timestamptz()
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  orchestration AgentOrchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)

  @@index([orchestrationId])
  @@index([conversationId])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@map("orchestration_executions")
}

model ABTest {
  id               String    @id @default(uuid()) @db.Uuid
  name             String    @db.VarChar(255)
  description      String?   @db.Text
  agentAId         String    @map("agent_a_id") @db.Uuid
  agentBId         String    @map("agent_b_id") @db.Uuid
  trafficSplit     Int       @default(50) @map("traffic_split")
  status           String    @default("draft") @db.VarChar(20)
  startedAt        DateTime? @map("started_at") @db.Timestamptz()
  endedAt          DateTime? @map("ended_at") @db.Timestamptz()
  totalInteractions Int      @default(0) @map("total_interactions")
  winnerAgentId    String?   @map("winner_agent_id") @db.Uuid
  createdBy        String    @map("created_by") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  interactions ABTestInteraction[]

  @@index([status])
  @@index([createdBy])
  @@index([startedAt])
  @@map("ab_tests")
}

model ABTestInteraction {
  id             String   @id @default(uuid()) @db.Uuid
  testId         String   @map("test_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  variant        String   @db.VarChar(1)
  metrics        Json     @default("{}")
  outcome        String?  @db.VarChar(50)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz()

  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([agentId])
  @@index([conversationId])
  @@index([createdAt(sort: Desc)])
  @@map("ab_test_interactions")
}

model Workspace {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(100)
  domain      String?  @db.VarChar(255)
  plan        String   @default("free") @db.VarChar(50)
  status      String   @default("active") @db.VarChar(20)
  settings    Json     @default("{}")
  branding    Json     @default("{}")
  ownerId     String   @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  users User[]

  @@index([slug])
  @@index([ownerId])
  @@index([status])
  @@map("workspaces")
}

model SsoConfig {
  id              String   @id @default(uuid()) @db.Uuid
  workspaceId     String   @map("workspace_id") @db.Uuid
  provider        String   @db.VarChar(50)
  enabled         Boolean  @default(false)
  config          Json     @default("{}")
  credentials     Json     @default("{}")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@map("sso_configs")
}

model ComplianceLog {
  id              String   @id @default(uuid()) @db.Uuid
  workspaceId     String?  @map("workspace_id") @db.Uuid
  leadId          String?  @map("lead_id") @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  action          String   @db.VarChar(100)
  category        String   @db.VarChar(50)
  details         Json     @default("{}")
  ipAddress       String?  @map("ip_address") @db.VarChar(50)
  userAgent       String?  @map("user_agent") @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([workspaceId])
  @@index([leadId])
  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@map("compliance_logs")
}

model DevSession {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  agentId   String   @map("agent_id") @db.Uuid
  messages  Json     @default("[]") // Stores array of {role, content, ...}
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  // Optional: Link to user if we want multi-user dev sessions later
  userId    String?  @map("user_id") @db.Uuid
  
  // Relation to Agent (optional constraint, can be loose if needed)
  // For now, let's make it a loose reference or real relation? 
  // Real relation ensures integrity but constraints deletion.
  // Let's use loose for flexibility or real for safety? Real is better for standard apps.
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([updatedAt(sort: Desc)])
  @@map("dev_sessions")
}

// ─────────────────────────────────────────────────────────
// Analytics Events — Product event tracking
// ─────────────────────────────────────────────────────────
model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?
  event      String   @db.VarChar(100)
  properties Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([event])
  @@index([createdAt(sort: Desc)])
  @@map("analytics_events")
}

// ─────────────────────────────────────────────────────────
// NPS Feedback — Net Promoter Score surveys
// ─────────────────────────────────────────────────────────
model NpsFeedback {
  id        String   @id @default(cuid())
  userId    String?
  score     Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([score])
  @@index([createdAt(sort: Desc)])
  @@map("nps_feedback")
}

// ─────────────────────────────────────────────────────────
// Subscription — Mercado Pago billing (Free / Pro / Business)
// ─────────────────────────────────────────────────────────
model Subscription {
  id                        String    @id @default(uuid()) @db.Uuid
  userId                    String    @unique @map("user_id") @db.Uuid
  plan                      String    @default("free") @db.VarChar(50)  // free | pro | business
  status                    String    @default("active") @db.VarChar(50) // active | canceled | past_due | trialing
  mercadoPagoPaymentId      String?   @map("mercadopago_payment_id") @db.VarChar(255)
  mercadoPagoSubscriptionId String?   @map("mercadopago_subscription_id") @db.VarChar(255)
  currentPeriodStart        DateTime? @map("current_period_start") @db.Timestamptz()
  currentPeriodEnd          DateTime? @map("current_period_end") @db.Timestamptz()
  canceledAt                DateTime? @map("canceled_at") @db.Timestamptz()
  // Usage tracking (reset monthly)
  messagesUsedMonth         Int       @default(0) @map("messages_used_month")
  usagePeriodStart          DateTime  @default(now()) @map("usage_period_start") @db.Timestamptz()
  createdAt                 DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                 DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([plan])
  @@index([status])
  @@index([mercadoPagoSubscriptionId])
  @@map("subscriptions")
}

// ─────────────────────────────────────────────────────────
// WebhookConfig — Output webhooks (Slack, Discord, email, generic)
// ─────────────────────────────────────────────────────────
model WebhookConfig {
  id        String   @id @default(cuid())
  userId    String
  name      String   @db.VarChar(255)
  type      String   @db.VarChar(50) // slack | discord | email | generic
  url       String?  @db.Text        // webhook URL for Slack/Discord/generic
  email     String?  @db.VarChar(255) // destination email for email type
  events    String[] @default([])    // orchestration_completed | agent_response | etc
  isActive  Boolean  @default(true)  @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([userId])
  @@index([isActive])
  @@map("webhook_configs")
}

// ─────────────────────────────────────────────────────────
// NewsletterSubscriber — Email newsletter signups
// ─────────────────────────────────────────────────────────
model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique @db.VarChar(255)
  name      String?  @db.VarChar(255)
  source    String?  @db.VarChar(100) // landing | blog | footer | early_access
  confirmed Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([email])
  @@index([confirmed])
  @@index([createdAt(sort: Desc)])
  @@map("newsletter_subscribers")
}
