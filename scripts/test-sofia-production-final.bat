@echo off
echo.
echo ===================================
echo üéØ TESTE FINAL AP√ìS DEPLOY COMPLETO
echo ===================================
echo.
echo ‚ö†Ô∏è EXECUTE APENAS AP√ìS:
echo 1. Deploy realizado (deploy-complete.bat)
echo 2. Restart da aplica√ß√£o no EasyPanel
echo 3. Aguardar 2-3 minutos para aplica√ß√£o subir
echo.

set API_URL=https://sofia-api.roilabs.com.br
set JQ_PATH="%LOCALAPPDATA%\Microsoft\WinGet\Packages\jqlang.jq_Microsoft.Winget.Source_8wekyb3d8bbwe\jq.exe"

echo ============================================
echo üì° 1. VERIFICANDO API AP√ìS DEPLOY...
echo ============================================
curl -s "%API_URL%/health" | %JQ_PATH% "{version: .version, uptime: .uptime, webhook_url: .webhook_system.webhook_url}"

echo.
echo ============================================
echo üÜï 2. TESTANDO NOVOS ENDPOINTS QR CODE...
echo ============================================
echo üîç Debug cache (deve funcionar agora):
curl -s "%API_URL%/api/debug/qr-cache" | %JQ_PATH% "."

echo.
echo ============================================
echo üì± 3. CRIANDO NOVA INST√ÇNCIA PARA QR...
echo ============================================
set NEW_INSTANCE=deploy-test-%RANDOM%
echo üìù Criando inst√¢ncia: %NEW_INSTANCE%

curl -s -X POST "%API_URL%/api/whatsapp/instances" ^
     -H "Content-Type: application/json" ^
     -d "{\"instanceName\":\"%NEW_INSTANCE%\"}" | %JQ_PATH% "."

echo.
echo ‚è≥ Aguardando 8 segundos para QR code via webhook...
timeout /t 8 /nobreak >nul

echo.
echo ============================================
echo üéØ 4. OBTENDO QR CODE REAL (MOMENTO DA VERDADE)...
echo ============================================
curl -s "%API_URL%/api/whatsapp/qrcode/%NEW_INSTANCE%" | %JQ_PATH% "."

echo.
echo ============================================
echo üìä 5. VERIFICANDO WEBHOOK SYSTEM...
echo ============================================
curl -s "%API_URL%/api/whatsapp/stats" | %JQ_PATH% "."

echo.
echo ============================================
echo üèÜ 6. RESULTADO FINAL...
echo ============================================
if exist qr_success.tmp (
    echo ‚úÖ QR CODES REAIS FUNCIONANDO!
    echo ‚úÖ DEPLOY COMPLETO REALIZADO COM SUCESSO!
    echo ‚úÖ SISTEMA SOFIA IA 100%% OPERACIONAL!
    del qr_success.tmp
) else (
    echo ‚ö†Ô∏è Verificar logs acima para status
    echo üí° Se webhooks n√£o funcionarem, verificar URL webhook
)

echo.
echo üéØ SOFIA IA PRONTO PARA PRODU√á√ÉO!
echo Inst√¢ncia criada: %NEW_INSTANCE%
echo.
pause