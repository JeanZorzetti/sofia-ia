# üß™ Teste Sofia IA - PowerShell Commands
# Execute cada comando individualmente

Write-Host "üîç 1. Verificar se servidor est√° rodando..." -ForegroundColor Green
try {
    $response = Invoke-WebRequest -Uri "http://localhost:8000/health" -Method GET -TimeoutSec 5
    Write-Host "‚úÖ Servidor ativo na porta 8000!" -ForegroundColor Green
    Write-Host $response.Content
} catch {
    Write-Host "‚ùå Servidor n√£o est√° rodando na porta 8000" -ForegroundColor Red
    Write-Host "Tentando porta 8001..." -ForegroundColor Yellow
    
    try {
        $response = Invoke-WebRequest -Uri "http://localhost:8001/health" -Method GET -TimeoutSec 5
        Write-Host "‚úÖ Servidor ativo na porta 8001!" -ForegroundColor Green
        $global:SOFIA_PORT = "8001"
    } catch {
        Write-Host "‚ùå Nenhum servidor Sofia IA encontrado. Execute o start script primeiro." -ForegroundColor Red
        exit
    }
}

if (-not $global:SOFIA_PORT) {
    $global:SOFIA_PORT = "8000"
}

Write-Host ""
Write-Host "üöÄ 2. Testando cria√ß√£o de inst√¢ncia WhatsApp..." -ForegroundColor Green

$body = @{
    name = "teste-qr-real-ps"
} | ConvertTo-Json

$headers = @{
    "Content-Type" = "application/json"
}

try {
    $response = Invoke-WebRequest -Uri "http://localhost:$global:SOFIA_PORT/api/whatsapp/instances" -Method POST -Body $body -Headers $headers -TimeoutSec 10
    Write-Host "‚úÖ Inst√¢ncia criada com sucesso!" -ForegroundColor Green
    Write-Host $response.Content
} catch {
    Write-Host "‚ùå Erro ao criar inst√¢ncia:" -ForegroundColor Red
    Write-Host $_.Exception.Message
}

Write-Host ""
Write-Host "üì± 3. Testando obten√ß√£o de QR Code..." -ForegroundColor Green

try {
    $response = Invoke-WebRequest -Uri "http://localhost:$global:SOFIA_PORT/api/whatsapp/instances/teste-qr-real-ps/qr" -Method GET -TimeoutSec 20
    Write-Host "‚úÖ QR Code obtido!" -ForegroundColor Green
    $qrData = $response.Content | ConvertFrom-Json
    
    if ($qrData.success) {
        Write-Host "üéØ Fonte: $($qrData.data.source)" -ForegroundColor Yellow
        Write-Host "‚è∞ Expira em: $($qrData.data.expires_in) segundos" -ForegroundColor Yellow
        Write-Host "üì∑ QR Code: $($qrData.data.qr_data_url.Substring(0, 50))..." -ForegroundColor Cyan
        Write-Host "‚úÖ QR Code real obtido com sucesso!" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Erro no QR Code: $($qrData.error)" -ForegroundColor Red
    }
} catch {
    Write-Host "‚ùå Erro ao obter QR Code:" -ForegroundColor Red
    Write-Host $_.Exception.Message
}

Write-Host ""
Write-Host "üìä 4. Verificando estat√≠sticas do webhook..." -ForegroundColor Green

try {
    $response = Invoke-WebRequest -Uri "http://localhost:$global:SOFIA_PORT/webhook/evolution/stats" -Method GET -TimeoutSec 5
    Write-Host "‚úÖ Estat√≠sticas obtidas!" -ForegroundColor Green
    Write-Host $response.Content
} catch {
    Write-Host "‚ùå Erro ao obter estat√≠sticas:" -ForegroundColor Red
    Write-Host $_.Exception.Message
}

Write-Host ""
Write-Host "üéØ TESTE CONCLU√çDO!" -ForegroundColor Green