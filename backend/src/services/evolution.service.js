/**
 * üöÄ SOFIA IA - Evolution API Service CORRIGIDO
 * Integra√ß√£o completa com evolutionapi.roilabs.com.br
 * ‚úÖ ROTAS CORRIGIDAS BASEADAS NO DEBUG REAL
 */

const axios = require('axios');

class EvolutionAPIService {
    constructor() {
        this.apiUrl = process.env.EVOLUTION_API_URL || 'https://evolutionapi.roilabs.com.br';
        this.apiKey = process.env.EVOLUTION_API_KEY || 'SuOOmamlmXs4NV3nkxpHAy7z3rcurbIz';
        this.defaultHeaders = {
            'apikey': this.apiKey,
            'Content-Type': 'application/json'
        };
        
        console.log('üîå Evolution API Service inicializado');
        console.log(`üìç URL: ${this.apiUrl}`);
        console.log(`üîë API Key: ${this.apiKey.substring(0, 10)}...`);
    }

    // üîÑ Health check da Evolution API
    async healthCheck() {
        try {
            const response = await axios.get(`${this.apiUrl}/`, {
                headers: this.defaultHeaders,
                timeout: 10000
            });
            
            return {
                success: true,
                status: 'online',
                data: response.data,
                version: response.data.version || 'unknown'
            };
        } catch (error) {
            console.error('‚ùå Evolution API Health Check falhou:', error.message);
            return {
                success: false,
                status: 'offline',
                error: error.message
            };
        }
    }

    // üì± Listar todas as inst√¢ncias WhatsApp ‚úÖ ROTA CORRIGIDA
    async listInstances() {
        try {
            console.log('üì± Buscando inst√¢ncias WhatsApp...');
            
            // ‚úÖ CORRE√á√ÉO: Usar /instance/fetchInstances ao inv√©s de /instance/list
            const response = await axios.get(`${this.apiUrl}/instance/fetchInstances`, {
                headers: this.defaultHeaders,
                timeout: 15000
            });
            
            const instances = response.data.map(instance => ({
                id: instance.name || instance.id,
                name: instance.name || instance.id,
                status: instance.connectionStatus || 'unknown',
                phone: instance.number || null,
                profileName: instance.profileName || null,
                profilePicUrl: instance.profilePicUrl || null,
                createdAt: instance.createdAt,
                messagesCount: instance._count?.Message || 0,
                contactsCount: instance._count?.Contact || 0,
                chatsCount: instance._count?.Chat || 0,
                token: instance.token,
                qrCode: instance.connectionStatus === 'close' ? 'pending' : null
            }));
            
            console.log(`‚úÖ ${instances.length} inst√¢ncias encontradas`);
            return {
                success: true,
                data: instances,
                total: instances.length
            };
            
        } catch (error) {
            console.error('‚ùå Erro ao listar inst√¢ncias:', error.message);
            return {
                success: false,
                error: error.message,
                data: []
            };
        }
    }

    // üÜï Criar nova inst√¢ncia WhatsApp ‚úÖ ROTA CORRIGIDA
    async createInstance(instanceName, settings = {}) {
        try {
            console.log(`üÜï Criando nova inst√¢ncia: ${instanceName}`);
            
            const instanceData = {
                instanceName: instanceName,
                qrcode: true,
                integration: 'WHATSAPP-BAILEYS',
                ...settings
            };
            
            // ‚úÖ CORRE√á√ÉO: Esta rota est√° funcionando e retorna QR code automaticamente
            const response = await axios.post(`${this.apiUrl}/instance/create`, instanceData, {
                headers: this.defaultHeaders,
                timeout: 20000
            });
            
            console.log(`‚úÖ Inst√¢ncia ${instanceName} criada com sucesso`);
            
            // ‚úÖ CORRE√á√ÉO: QR code vem no response da cria√ß√£o!
            const qrData = response.data.qrcode;
            
            return {
                success: true,
                data: {
                    instanceName: instanceName,
                    instanceId: response.data.instance?.instanceId,
                    status: response.data.instance?.status || 'connecting',
                    qrcode: qrData?.base64 || qrData?.code,
                    hash: response.data.hash,
                    integration: response.data.instance?.integration
                }
            };
            
        } catch (error) {
            console.error(`‚ùå Erro ao criar inst√¢ncia ${instanceName}:`, error.message);
            
            // Se erro 409 = inst√¢ncia j√° existe, tentar obter QR code
            if (error.response?.status === 409) {
                console.log(`‚ö†Ô∏è Inst√¢ncia ${instanceName} j√° existe, tentando obter QR code...`);
                return await this.getInstanceQRCode(instanceName);
            }
            
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üîó Conectar inst√¢ncia (obter QR Code) ‚úÖ L√ìGICA CORRIGIDA
    async connectInstance(instanceName) {
        try {
            console.log(`üîó Conectando inst√¢ncia: ${instanceName}`);
            
            // ‚úÖ CORRE√á√ÉO: Primeiro verificar se inst√¢ncia existe
            const instances = await this.listInstances();
            if (!instances.success) {
                throw new Error('N√£o foi poss√≠vel verificar inst√¢ncias existentes');
            }
            
            const existingInstance = instances.data.find(i => 
                i.id === instanceName || i.name === instanceName
            );
            
            if (existingInstance) {
                // Inst√¢ncia existe - tentar obter QR code
                return await this.getInstanceQRCode(instanceName);
            } else {
                // Inst√¢ncia n√£o existe - criar nova (que retorna QR automaticamente)
                console.log(`üÜï Inst√¢ncia ${instanceName} n√£o existe, criando...`);
                return await this.createInstance(instanceName);
            }
            
        } catch (error) {
            console.error(`‚ùå Erro ao conectar inst√¢ncia ${instanceName}:`, error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üì± Obter QR Code de inst√¢ncia existente ‚úÖ M√âTODO NOVO
    async getInstanceQRCode(instanceName) {
        try {
            console.log(`üì± Obtendo QR code para ${instanceName}...`);
            
            // Tentar v√°rias rotas poss√≠veis para QR code
            const qrRoutes = [
                `/instance/connect/${instanceName}`,
                `/instance/${instanceName}/qrcode`,
                `/instance/qrcode/${instanceName}`,
                `/instance/${instanceName}/connect`
            ];
            
            for (const route of qrRoutes) {
                try {
                    const response = await axios.get(`${this.apiUrl}${route}`, {
                        headers: this.defaultHeaders,
                        timeout: 15000,
                        validateStatus: () => true
                    });
                    
                    if (response.status === 200 && response.data) {
                        console.log(`‚úÖ QR code obtido via ${route}`);
                        
                        return {
                            success: true,
                            data: {
                                instanceName: instanceName,
                                qrcode: response.data.qrcode || response.data.base64 || response.data.code,
                                status: 'connecting',
                                source: route
                            }
                        };
                    }
                    
                } catch (routeError) {
                    console.log(`‚ö†Ô∏è Rota ${route} falhou: ${routeError.message}`);
                    continue;
                }
            }
            
            // Se nenhuma rota funcionou, tentar recriar a inst√¢ncia
            console.log(`üîÑ Todas as rotas QR falharam, recriando inst√¢ncia ${instanceName}...`);
            
            // Primeiro deletar se existir
            await this.deleteInstance(instanceName);
            
            // Aguardar um pouco
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Criar nova inst√¢ncia
            return await this.createInstance(instanceName);
            
        } catch (error) {
            console.error(`‚ùå Erro ao obter QR code para ${instanceName}:`, error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // ‚ùå Desconectar inst√¢ncia ‚úÖ ROTA CORRIGIDA
    async disconnectInstance(instanceName) {
        try {
            console.log(`‚ùå Desconectando inst√¢ncia: ${instanceName}`);
            
            const response = await axios.delete(`${this.apiUrl}/instance/logout/${instanceName}`, {
                headers: this.defaultHeaders,
                timeout: 10000
            });
            
            return {
                success: true,
                data: {
                    instanceName: instanceName,
                    status: 'disconnected'
                }
            };
            
        } catch (error) {
            console.error(`‚ùå Erro ao desconectar inst√¢ncia ${instanceName}:`, error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üóëÔ∏è Deletar inst√¢ncia ‚úÖ ROTA CORRIGIDA
    async deleteInstance(instanceName) {
        try {
            console.log(`üóëÔ∏è Deletando inst√¢ncia: ${instanceName}`);
            
            const response = await axios.delete(`${this.apiUrl}/instance/delete/${instanceName}`, {
                headers: this.defaultHeaders,
                timeout: 10000,
                validateStatus: () => true // Aceitar qualquer status
            });
            
            return {
                success: response.status < 400,
                data: {
                    instanceName: instanceName,
                    status: 'deleted'
                }
            };
            
        } catch (error) {
            console.error(`‚ùå Erro ao deletar inst√¢ncia ${instanceName}:`, error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üì§ Enviar mensagem ‚úÖ ROTA CORRIGIDA
    async sendMessage(instanceName, to, message, type = 'text') {
        try {
            console.log(`üì§ Enviando mensagem via ${instanceName} para ${to}`);
            
            const messageData = {
                number: to,
                options: {
                    delay: 1200,
                    presence: 'composing'
                }
            };

            if (type === 'text') {
                messageData.textMessage = {
                    text: message
                };
            }
            
            const response = await axios.post(`${this.apiUrl}/message/sendText/${instanceName}`, messageData, {
                headers: this.defaultHeaders,
                timeout: 15000
            });
            
            return {
                success: true,
                data: response.data
            };
            
        } catch (error) {
            console.error(`‚ùå Erro ao enviar mensagem:`, error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üîî Configurar webhooks ‚úÖ ROTA CORRIGIDA
    async configureWebhook(instanceName, webhookUrl, events = []) {
        try {
            console.log(`üîî Configurando webhook para ${instanceName}`);
            
            const webhookData = {
                url: webhookUrl,
                events: events.length > 0 ? events : [
                    'MESSAGES_UPSERT',
                    'MESSAGE_STATUS_UPDATE',
                    'PRESENCE_UPDATE',
                    'QRCODE_UPDATED',
                    'CONNECTION_UPDATE'
                ],
                webhook_by_events: false
            };
            
            const response = await axios.post(`${this.apiUrl}/webhook/set/${instanceName}`, webhookData, {
                headers: this.defaultHeaders,
                timeout: 10000
            });
            
            return {
                success: true,
                data: response.data
            };
            
        } catch (error) {
            console.error(`‚ùå Erro ao configurar webhook:`, error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üìä Obter estat√≠sticas da inst√¢ncia
    async getInstanceStats(instanceName) {
        try {
            const [chats, contacts] = await Promise.all([
                this.getChats(instanceName),
                this.getContacts(instanceName)
            ]);
            
            return {
                success: true,
                data: {
                    chats: chats.success ? chats.data.length : 0,
                    contacts: contacts.success ? contacts.data.length : 0
                }
            };
            
        } catch (error) {
            return {
                success: false,
                error: error.message,
                data: { chats: 0, contacts: 0 }
            };
        }
    }

    // üí¨ Listar chats
    async getChats(instanceName) {
        try {
            const response = await axios.get(`${this.apiUrl}/chat/findMany/${instanceName}`, {
                headers: this.defaultHeaders,
                timeout: 10000
            });
            
            return {
                success: true,
                data: response.data
            };
            
        } catch (error) {
            return {
                success: false,
                error: error.message,
                data: []
            };
        }
    }

    // üë• Listar contatos
    async getContacts(instanceName) {
        try {
            const response = await axios.get(`${this.apiUrl}/contact/findMany/${instanceName}`, {
                headers: this.defaultHeaders,
                timeout: 10000
            });
            
            return {
                success: true,
                data: response.data
            };
            
        } catch (error) {
            return {
                success: false,
                error: error.message,
                data: []
            };
        }
    }

    // üéØ Processar webhook recebido
    async processWebhook(webhookData) {
        try {
            console.log('üéØ Processando webhook recebido:', webhookData.event);
            
            const { event, instance, data } = webhookData;
            
            switch (event) {
                case 'MESSAGES_UPSERT':
                    return await this.processMessage(instance, data);
                case 'QRCODE_UPDATED':
                    return await this.processQRCode(instance, data);
                case 'CONNECTION_UPDATE':
                    return await this.processConnectionUpdate(instance, data);
                default:
                    console.log(`‚ÑπÔ∏è Evento n√£o processado: ${event}`);
                    return { success: true, processed: false };
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao processar webhook:', error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // üí¨ Processar mensagem recebida
    async processMessage(instance, messageData) {
        console.log(`üí¨ Nova mensagem em ${instance}:`, messageData.key?.remoteJid);
        
        // Aqui ser√° integrado com Claude IA posteriormente
        return {
            success: true,
            action: 'message_received',
            instance: instance,
            from: messageData.key?.remoteJid,
            message: messageData.message
        };
    }

    // üì± Processar QR Code atualizado
    async processQRCode(instance, qrData) {
        console.log(`üì± QR Code atualizado para ${instance}`);
        
        return {
            success: true,
            action: 'qr_updated',
            instance: instance,
            qrcode: qrData.qrcode
        };
    }

    // üîó Processar atualiza√ß√£o de conex√£o
    async processConnectionUpdate(instance, connectionData) {
        console.log(`üîó Status de conex√£o atualizado para ${instance}:`, connectionData.state);
        
        return {
            success: true,
            action: 'connection_updated',
            instance: instance,
            status: connectionData.state
        };
    }
}

module.exports = EvolutionAPIService;
