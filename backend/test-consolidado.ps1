# üöÄ TESTE SISTEMA SOFIA IA CONSOLIDADO v4.0.0
# Script PowerShell para Windows - Testar integra√ß√£o completa

param(
    [switch]$SkipBackup = $false
)

Write-Host "üè† ==========================================" -ForegroundColor Yellow
Write-Host "üöÄ INICIANDO TESTES SOFIA IA v4.0.0" -ForegroundColor Green
Write-Host "‚úÖ SISTEMA CONSOLIDADO - EVOLUTION UNIFICADO" -ForegroundColor Green
Write-Host "üè† ==========================================" -ForegroundColor Yellow

# Verificar se est√° no diret√≥rio correto
if (-not (Test-Path "src\app.UNIFIED.js")) {
    Write-Host "‚ùå ERRO: Execute este script do diret√≥rio backend\" -ForegroundColor Red
    exit 1
}

Write-Host "üìÅ Diret√≥rio correto detectado" -ForegroundColor Green

# Fazer backup dos arquivos atuais
if (-not $SkipBackup) {
    Write-Host "üíæ Fazendo backup dos arquivos atuais..." -ForegroundColor Cyan
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    
    if (Test-Path "src\app.js") {
        Copy-Item "src\app.js" "src\app.js.BACKUP.$timestamp" -ErrorAction SilentlyContinue
    }
    if (Test-Path "src\routes\webhook.routes.js") {
        Copy-Item "src\routes\webhook.routes.js" "src\routes\webhook.routes.js.BACKUP.$timestamp" -ErrorAction SilentlyContinue
    }
}

# Substituir pelos arquivos consolidados
Write-Host "üîÑ Aplicando arquivos consolidados..." -ForegroundColor Cyan
Copy-Item "src\app.UNIFIED.js" "src\app.js" -Force
Copy-Item "src\routes\webhook.routes.UNIFIED.js" "src\routes\webhook.routes.js" -Force
Copy-Item "src\services\evolution.service.UNIFIED.js" "src\services\evolution.service.js" -Force

Write-Host "‚úÖ Arquivos consolidados aplicados" -ForegroundColor Green

# Verificar Node.js
Write-Host "üì¶ Verificando depend√™ncias..." -ForegroundColor Cyan
try {
    $nodeVersion = node --version
    Write-Host "‚úÖ Node.js encontrado: $nodeVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Node.js n√£o encontrado" -ForegroundColor Red
    exit 1
}

if (-not (Test-Path "package.json")) {
    Write-Host "‚ùå package.json n√£o encontrado" -ForegroundColor Red
    exit 1
}

# Instalar depend√™ncias se necess√°rio
if (-not (Test-Path "node_modules")) {
    Write-Host "üì¶ Instalando depend√™ncias..." -ForegroundColor Cyan
    npm install
}

# Verificar/criar arquivo .env
Write-Host "üîê Verificando configura√ß√µes..." -ForegroundColor Cyan
if (-not (Test-Path ".env")) {
    Write-Host "‚ö†Ô∏è  Arquivo .env n√£o encontrado - criando valores padr√£o" -ForegroundColor Yellow
    
    $envContent = @"
# Sofia IA - Environment Variables
PORT=8000
NODE_ENV=development

# Evolution API
EVOLUTION_API_URL=https://evolutionapi.roilabs.com.br
EVOLUTION_API_KEY=SuOOmamlmXs4NV3nkxpHAy7z3rcurbIz
WEBHOOK_URL=http://localhost:8000/webhook/evolution

# Database (n√£o necess√°rio para este teste)
# DATABASE_URL=postgresql://...
"@
    
    $envContent | Out-File -FilePath ".env" -Encoding UTF8
    Write-Host "‚úÖ Arquivo .env criado com valores padr√£o" -ForegroundColor Green
}

Write-Host "‚úÖ Configura√ß√µes verificadas" -ForegroundColor Green

# Verificar se porta 8000 est√° livre
Write-Host "üîç Verificando porta 8000..." -ForegroundColor Cyan
$portInUse = Get-NetTCPConnection -LocalPort 8000 -ErrorAction SilentlyContinue
if ($portInUse) {
    Write-Host "‚ö†Ô∏è  Porta 8000 em uso - tentando liberar..." -ForegroundColor Yellow
    
    # Tentar encontrar e finalizar processo Node.js na porta 8000
    $processes = Get-WmiObject Win32_Process | Where-Object { $_.CommandLine -like "*node*" -and $_.CommandLine -like "*8000*" }
    foreach ($proc in $processes) {
        Write-Host "üõë Finalizando processo Node.js (PID: $($proc.ProcessId))" -ForegroundColor Yellow
        Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue
    }
    
    Start-Sleep -Seconds 2
}

# Iniciar servidor
Write-Host "üöÄ Iniciando servidor Sofia IA..." -ForegroundColor Green
$serverJob = Start-Job -ScriptBlock {
    Set-Location $using:PWD
    node src\app.js
}

# Aguardar servidor inicializar
Write-Host "‚è≥ Aguardando servidor inicializar..." -ForegroundColor Yellow
Start-Sleep -Seconds 5

# Fun√ß√£o para testar endpoint
function Test-Endpoint {
    param($url, $name)
    
    try {
        $response = Invoke-RestMethod -Uri $url -Method Get -TimeoutSec 10
        Write-Host "‚úÖ $name funcionando" -ForegroundColor Green
        return $true
    } catch {
        Write-Host "‚ùå $name falhou: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Testar endpoints principais
Write-Host "üß™ ==========================================" -ForegroundColor Yellow
Write-Host "üß™ INICIANDO TESTES DE ENDPOINTS" -ForegroundColor Yellow
Write-Host "üß™ ==========================================" -ForegroundColor Yellow

$testResults = @()

# Teste 1: Health Check
Write-Host "ü©∫ Teste 1: Health Check" -ForegroundColor Cyan
$testResults += Test-Endpoint "http://localhost:8000/health" "Health Check"

# Teste 2: Dashboard Overview
Write-Host "üìä Teste 2: Dashboard Overview" -ForegroundColor Cyan
$testResults += Test-Endpoint "http://localhost:8000/api/dashboard/overview" "Dashboard Overview"

# Teste 3: WhatsApp Instances
Write-Host "üì± Teste 3: WhatsApp Instances" -ForegroundColor Cyan
$testResults += Test-Endpoint "http://localhost:8000/api/whatsapp/instances" "WhatsApp Instances"

# Teste 4: Webhook Health
Write-Host "üîî Teste 4: Webhook Health" -ForegroundColor Cyan
$testResults += Test-Endpoint "http://localhost:8000/webhook/evolution" "Webhook Health"

# Teste 5: QR Code Endpoint
Write-Host "üì± Teste 5: QR Code (simulado)" -ForegroundColor Cyan
$testResults += Test-Endpoint "http://localhost:8000/api/whatsapp/qrcode/teste-consolidado" "QR Code endpoint"

# Teste 6: Evolution API Health
Write-Host "üåê Teste 6: Evolution API Health" -ForegroundColor Cyan
try {
    $headers = @{ "apikey" = "SuOOmamlmXs4NV3nkxpHAy7z3rcurbIz" }
    $evolutionResponse = Invoke-RestMethod -Uri "https://evolutionapi.roilabs.com.br/instance/fetchInstances" -Headers $headers -TimeoutSec 10
    Write-Host "‚úÖ Evolution API acess√≠vel" -ForegroundColor Green
    $testResults += $true
} catch {
    Write-Host "‚ö†Ô∏è  Evolution API indispon√≠vel - usando fallback" -ForegroundColor Yellow
    $testResults += $false
}

# Teste 7: Cria√ß√£o de Inst√¢ncia
Write-Host "üèóÔ∏è Teste 7: Cria√ß√£o de Inst√¢ncia" -ForegroundColor Cyan
try {
    $body = @{
        instanceName = "teste-powershell"
        settings = @{}
    } | ConvertTo-Json
    
    $response = Invoke-RestMethod -Uri "http://localhost:8000/api/whatsapp/instances" -Method Post -Body $body -ContentType "application/json" -TimeoutSec 10
    Write-Host "‚úÖ Cria√ß√£o de inst√¢ncia funcionando" -ForegroundColor Green
    $testResults += $true
} catch {
    Write-Host "‚ùå Cria√ß√£o de inst√¢ncia falhou: $($_.Exception.Message)" -ForegroundColor Red
    $testResults += $false
}

Write-Host "üß™ ==========================================" -ForegroundColor Yellow
Write-Host "üß™ TESTES CONCLU√çDOS" -ForegroundColor Yellow
Write-Host "üß™ ==========================================" -ForegroundColor Yellow

# Calcular resultado geral
$totalTests = $testResults.Count
$passedTests = ($testResults | Where-Object { $_ -eq $true }).Count
$successRate = [math]::Round(($passedTests / $totalTests) * 100, 1)

Write-Host "üìã Resultado dos testes:" -ForegroundColor White
Write-Host "   ‚Ä¢ Total de testes: $totalTests" -ForegroundColor White
Write-Host "   ‚Ä¢ Sucessos: $passedTests" -ForegroundColor Green
Write-Host "   ‚Ä¢ Falhas: $($totalTests - $passedTests)" -ForegroundColor Red
Write-Host "   ‚Ä¢ Taxa de sucesso: $successRate%" -ForegroundColor $(if ($successRate -ge 80) { "Green" } else { "Yellow" })

# Mostrar informa√ß√µes do servidor
Write-Host "üìã Informa√ß√µes do servidor:" -ForegroundColor White
try {
    $healthInfo = Invoke-RestMethod -Uri "http://localhost:8000/health" -TimeoutSec 5
    Write-Host "   ‚Ä¢ Servi√ßo: $($healthInfo.service)" -ForegroundColor White
    Write-Host "   ‚Ä¢ Vers√£o: $($healthInfo.version)" -ForegroundColor White
    Write-Host "   ‚Ä¢ Status: $($healthInfo.status)" -ForegroundColor Green
} catch {
    Write-Host "   ‚Ä¢ Status: Indispon√≠vel" -ForegroundColor Red
}

Write-Host ""
Write-Host "üéØ ==========================================" -ForegroundColor Yellow
Write-Host "üéØ RESULTADOS DO TESTE" -ForegroundColor Yellow
Write-Host "üéØ ==========================================" -ForegroundColor Yellow

if ($successRate -ge 80) {
    Write-Host "‚úÖ Sistema consolidado funcionando corretamente!" -ForegroundColor Green
    Write-Host "‚úÖ Evolution API service unificado operacional" -ForegroundColor Green
    Write-Host "‚úÖ Endpoints principais respondendo" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è  Sistema parcialmente funcional" -ForegroundColor Yellow
    Write-Host "‚ö†Ô∏è  Alguns endpoints podem precisar de ajustes" -ForegroundColor Yellow
}

Write-Host ""
Write-Host "üìç URLs importantes:" -ForegroundColor White
Write-Host "   ‚Ä¢ Health: http://localhost:8000/health" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ Dashboard: http://localhost:8000/api/dashboard/overview" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ WhatsApp: http://localhost:8000/api/whatsapp/instances" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ Webhook: http://localhost:8000/webhook/evolution" -ForegroundColor Cyan
Write-Host ""

# Perguntar se quer manter servidor ativo
$keepRunning = Read-Host "üîß Manter servidor ativo para testes manuais? (y/N)"

if ($keepRunning -eq "y" -or $keepRunning -eq "Y") {
    Write-Host "‚è≥ Servidor mantido ativo para testes manuais..." -ForegroundColor Green
    Write-Host "‚è≥ Pressione Ctrl+C para finalizar" -ForegroundColor Yellow
    
    try {
        # Aguardar job do servidor
        Wait-Job -Job $serverJob
    } catch {
        Write-Host "üõë Servidor interrompido" -ForegroundColor Yellow
    }
} else {
    Write-Host "üõë Finalizando servidor..." -ForegroundColor Yellow
    Stop-Job -Job $serverJob -ErrorAction SilentlyContinue
    Remove-Job -Job $serverJob -ErrorAction SilentlyContinue
}

Write-Host ""
Write-Host "üéØ Teste Sofia IA Consolidado conclu√≠do!" -ForegroundColor Green
Write-Host "üéØ Sistema pronto para uso em produ√ß√£o!" -ForegroundColor Green
Write-Host "üè† ==========================================" -ForegroundColor Yellow