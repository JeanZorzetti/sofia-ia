@echo off
echo.
echo ===================================
echo üéØ TESTE AP√ìS CORRE√á√ÉO WEBHOOK URL
echo ===================================
echo.
echo ‚ö†Ô∏è EXECUTE APENAS AP√ìS:
echo 1. Alterar WEBHOOK_URL no EasyPanel
echo 2. Restart da aplica√ß√£o
echo 3. Aguardar 2-3 minutos
echo.

set API_URL=https://sofia-api.roilabs.com.br
set JQ_PATH="%LOCALAPPDATA%\Microsoft\WinGet\Packages\jqlang.jq_Microsoft.Winget.Source_8wekyb3d8bbwe\jq.exe"

echo ============================================
echo üîç 1. VERIFICANDO WEBHOOK URL CORRIGIDA...
echo ============================================
curl -s "%API_URL%/health" | %JQ_PATH% ".webhook_system.webhook_url"

echo.
echo üí° Deve mostrar: https://sofia-api.roilabs.com.br/webhook/evolution
echo ‚ùå Se ainda mostrar localhost, repetir corre√ß√£o no EasyPanel
echo.

echo ============================================
echo üì± 2. CRIANDO INST√ÇNCIA COM WEBHOOK CORRETO...
echo ============================================
set TEST_INSTANCE=webhook-test-%RANDOM%
echo üÜï Criando inst√¢ncia: %TEST_INSTANCE%

curl -s -X POST "%API_URL%/api/whatsapp/instances" ^
     -H "Content-Type: application/json" ^
     -d "{\"instanceName\":\"%TEST_INSTANCE%\"}" | %JQ_PATH% ".data.instanceName, .data.status"

echo.
echo ‚è≥ Aguardando 10 segundos para webhook chegar...
timeout /t 10 /nobreak >nul

echo.
echo ============================================
echo üéØ 3. MOMENTO DA VERDADE - QR CODE REAL...
echo ============================================
curl -s "%API_URL%/api/whatsapp/qrcode/%TEST_INSTANCE%" > final_qr_test.json
echo üìù Resposta completa:
type final_qr_test.json
echo.
echo üìä Analisando source:
%JQ_PATH% ".data.source" final_qr_test.json 2>nul

echo.
echo ============================================
echo üìä 4. VERIFICANDO CACHE DE WEBHOOKS...
echo ============================================
curl -s "%API_URL%/api/debug/qr-cache" | %JQ_PATH% ".total, .active"

echo.
echo ============================================
echo üèÜ 5. RESULTADO FINAL...
echo ============================================
set /p source=<%JQ_PATH% -r ".data.source" final_qr_test.json 2>nul
if "%source%"=="webhook" (
    echo üéâ SUCESSO TOTAL!
    echo ‚úÖ QR code recebido via WEBHOOK REAL!
    echo ‚úÖ Evolution API ‚Üí Sofia IA funcionando!
    echo ‚úÖ Sistema 100%% operacional!
) else (
    echo ‚ö†Ô∏è Ainda usando fallback
    echo üí° Verificar se webhook URL foi alterado corretamente
    echo üîß Pode precisar reiniciar aplica√ß√£o novamente
)

echo.
echo üéØ Inst√¢ncia de teste: %TEST_INSTANCE%
echo üìÅ Resposta salva em: final_qr_test.json
echo.
pause

del final_qr_test.json 2>nul